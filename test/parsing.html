<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Parsing</title>
    <link rel="stylesheet" href="views.css">
    <style>
    
      article {
        margin: 1em 0;
      }
    
      article.fail {
        background: #fcc;
      }
    
      article.pass {
        background: #cfc;
      }
      
    </style>
  </head>
  <body>
    
    <section id="results">
    </section>
    
    <script src="../lib/zepto.js"></script>
    <script src="../src/relation.js"></script>
    <script src="../src/set.js"></script>
    <script src="../src/parser.js"></script>
    <script src="../src/grammar.js"></script>
    <script src="../src/calculations.js"></script>
    <script src="../src/calculations/grammar.js"></script>
    <script src="../src/helpers.js"></script>
    <script src="../src/views.js"></script>
    <script src="../src/views/productions.js"></script>
    <script>
      
      function productionsEqual(a, b) {
        
        var i, j;
        
        if (a.length !== b.length)
          return false;
        
        for (i = 0; i < a.length; i++) {
          if (a[i].length !== b[i].length)
            return false;
          
          for (j = 0; j < a[i].length; j++) {
            if (a[i][j] !== b[i][j])
              return false;
          }
        }
        
        return true;
        
      }
      
      function inspectProductionsAsList(productions) {
        
        return "<ul class=\"p\">" + productions.map(function(p) {
          
          return "<li>" +
            "<b>" + Helpers.escapeHTML(p[0]) + "</b> &rarr; " +
            p.slice(1).map(function(s) { return "<b>" + Helpers.escapeHTML(s) + "</b>"; }) +
            "</li>";
          
        }) + "</ul>";
        
      }
      
      function fail(message) {
        
        $("#results").append("<article class=\"fail\">" + message + "</article>");
        
      }
      
      function assertProductions(spec, expected) {
        
        var grammar;
        var i, j;
        
        try {
          
          grammar = Grammar.parse(spec);
          
          if (!productionsEqual(expected, grammar.productions)) {
            fail("<p>Expected:</p>" + inspectProductionsAsList(expected) + "<p>Actual:</p>" + inspectProductionsAsList(grammar.productions) + "<p>Spec:</p><pre>" + spec + "</pre>");
            return false;
          }
          
        } catch (e) {
          
          fail("<p>Unexpected parse error:</p><pre>" + e.toString() + "</pre><p>Spec:</p><pre>" + spec + "</pre>");
          return false;
          
        }
        
        return true;
        
      }
      
      function assertParseError(spec) {
        
        try {
          
          var grammar = Grammar.parse(spec);
          
          fail("<p>Expected parse error for spec, none thrown:</p><pre>" + spec + "</pre>");
          return false;
          
        } catch (e) {
          
          return true;
          
        }
        
      }
      
      var passing = true;
      
      passing &= assertProductions("A -> a | b.", [["A", "a"], ["A", "b"]]);
      passing &= assertProductions("A -> a. B -> b.", [["A", "a"], ["B", "b"]]);
      passing &= assertProductions("A->a.", [["A", "a"]]);
      passing &= assertProductions("1 -> 5 6.", [["1", "5", "6"]]);
      passing &= assertProductions("** -> 42.", [["**", "42"]]);
      passing &= assertProductions("A -> x - y.", [["A", "x", "-", "y"]]);
      passing &= assertProductions("-->-. - -> -.", [["-", "-"], ["-", "-"]]);
      passing &= assertProductions("A -> x > y.", [["A", "x", ">", "y"]]);
      passing &= assertProductions("\"x.y\" -> \" \" \"->\".", [["x.y", " ", "->"]]);
      passing &= assertProductions("A -> \\\".", [["A", "\""]]);
      passing &= assertProductions("A -> \\..", [["A", "."]]);
      
      passing &= assertParseError("A -> a. B");
      passing &= assertParseError("A.y -> a.");
      passing &= assertParseError("A B -> a.");
      passing &= assertParseError("A -> a. ->");
      passing &= assertParseError("-> X");
      passing &= assertParseError("A");
      passing &= assertParseError("A -> \"x");
      
      if (passing)
        $("#results").append("<article class=\"pass\">Passed!</article>");
      
    </script>
    
  </body>
</html>
