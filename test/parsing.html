<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Parsing</title>
    <style>
    
      article {
        margin: 1em 0;
      }
    
      article.fail {
        background: #fcc;
      }
      
      article.fail b {
        background: #ebb;
      }
    
      article.pass {
        background: #cfc;
      }
      
      article.pass b {
        background: #beb;
      }
      
    </style>
  </head>
  <body>
    
    <section id="results">
    </section>
    
    <script src="/assets/application.js"></script>
    <script>
      
      function productionsEqual(a, b) {
        
        var i, j;
        
        if (a.length !== b.length)
          return false;
        
        for (i = 0; i < a.length; i++) {
          if (a[i].length !== b[i].length)
            return false;
          
          for (j = 0; j < a[i].length; j++) {
            if (a[i][j] !== b[i][j])
              return false;
          }
        }
        
        return true;
        
      }
      
      function inspectProductionsAsList(productions) {
        
        return "<ul class=\"p\">" + productions.map(function(p) {
          
          return "<li>" +
            "<b>" + Helpers.escapeHTML(p[0]) + "</b> &rarr; " +
            p.slice(1).map(function(s) { return "<b>" + Helpers.escapeHTML(s) + "</b>"; }).join(" ") +
            "</li>";
          
        }).join("") + "</ul>";
        
      }
      
      function fail(message) {
        
        $("#results").append("<article class=\"fail\">" + message + "</article>");
        
      }
      
      function pass(message) {
        
        $("#results").append("<article class=\"pass\">" + message + "</article>");
        
      }
      
      function assertProductions(spec, expected) {
        
        var result = Grammar.parse(spec);
        
        if (result.error) {
          
          fail("<p>Unexpected parse error:</p><pre>" + result.error.toString() + "</pre><p>Spec:</p><pre>" + spec + "</pre>");
          return 1;
          
        } else {
          
          if (!productionsEqual(expected, result.grammar.productions)) {
            fail("<p>Expected:</p>" + inspectProductionsAsList(expected) + "<p>Actual:</p>" + inspectProductionsAsList(result.grammar.productions) + "<p>Spec:</p><pre>" + spec + "</pre>");
            return 1;
          }
          
        }
        
        pass("<pre>" + spec + "</pre>" + inspectProductionsAsList(expected));
        return 0;
        
      }
      
      function assertParseError(spec) {
        
        var result = Grammar.parse(spec);
        
        if (result.error) {
          
          pass("<pre>" + spec + "</pre><pre>" + result.error.toString() + "</pre>");
          return 0;
          
        } else {
          
          fail("<p>Expected parse error for spec, none thrown:</p><pre>" + spec + "</pre>");
          return 1;
          
        }
        
      }
      
      var failures = 0;
      
      failures += assertProductions("A -> a | b.", [["A", "a"], ["A", "b"]]);
      failures += assertProductions("A->a|b.", [["A", "a"], ["A", "b"]]);
      failures += assertProductions("A -> .", [["A"]]);
      failures += assertProductions("A->.", [["A"]]);
      failures += assertProductions("A -> a. B -> b.", [["A", "a"], ["B", "b"]]);
      failures += assertProductions("A->a.", [["A", "a"]]);
      failures += assertProductions("1 -> 5 6.", [["1", "5", "6"]]);
      failures += assertProductions("** -> 42.", [["**", "42"]]);
      failures += assertProductions("A -> x - y.", [["A", "x", "-", "y"]]);
      failures += assertProductions("-->-. - -> -.", [["-", "-"], ["-", "-"]]);
      failures += assertProductions("A -> x > y.", [["A", "x", ">", "y"]]);
      failures += assertProductions("\"x.y\" -> \" \" \"->\".", [["x.y", " ", "->"]]);
      failures += assertProductions("'x.y' -> ' ' '->'.", [["x.y", " ", "->"]]);
      failures += assertProductions("a -> \"'\" \"\\\"\" '\\'' '\"'.", [["a", "'", "\"", "'", "\""]]);
      failures += assertProductions("A -> \\\".", [["A", "\""]]);
      failures += assertProductions("A -> \\..", [["A", "."]]);
      failures += assertProductions("A -> a\\.a.", [["A", "a.a"]]);
      failures += assertProductions("a -> a-b.", [["a", "a-b"]]);
      failures += assertProductions("a-b -> a-b.", [["a-b", "a-b"]]);
      failures += assertProductions("a-b->a-b.", [["a-b", "a-b"]]);
      failures += assertProductions("a'->x.", [["a'", "x"]]);
      failures += assertProductions("a''->x'''.y'->b''.", [["a''", "x'''"], ["y'", "b''"]]);
      
      failures += assertParseError("A -> a. B");
      failures += assertParseError("A.y -> a.");
      failures += assertParseError("A B -> a.");
      failures += assertParseError("A -> a. ->");
      failures += assertParseError("-> X");
      failures += assertParseError("A");
      failures += assertParseError("A -> \"x");
      failures += assertParseError("A -> \"x\\\"");
      failures += assertParseError("a->x.y .");
      failures += assertParseError("a -> '.");
      failures += assertParseError("a -> \".");
      failures += assertParseError("a -> b\"c\".");
      failures += assertParseError("a -> b'c.");
      failures += assertParseError("a -> b'''c.");
      failures += assertParseError("a -> b'c '.");
      failures += assertParseError("a -> \"\".");
      failures += assertParseError("a -> ''.");
      
      if (failures > 0)
        $("#results").prepend("<article class=\"fail\">" + failures + " " + (failures == 1 ? "failure" : "failures") + "!</article>");
      
    </script>
    
  </body>
</html>
