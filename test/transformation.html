<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Transformation</title>
    <style>
      
      article {
        margin: 1em 0;
      }
      
      button {
        display: block;
      }
      
      body.transform #transform,
      body.edit #edit {
        display: none;
      }
      
      body.edit #results,
      body.transform #spec {
        display: none;
      }
      
      #spec {
        width: 300px;
        height: 150px;
        font: 12pt courier;
      }
      
    </style>
  </head>
  <body class="transform">
    
    <nav id="buttons">
      <button id="edit">Edit</button>
      <button id="transform">Transform</button>
    </nav>
    
    <textarea id="spec">
</textarea>
    
    <section id="results">
    </section>
    
    <script src="/assets/application.js"></script>
    <script>
    
      var TransformView = (function() {
  
        function initialize() {
          this.element = $("<article></article>");
        }
        
        function formatTransformation(transformation, productions, info) {
          
          if (transformation.name == "expand")
            return "Expand " + Helpers.formatSymbol(productions[transformation.production][transformation.symbol], info);
          else if (transformation.name == "removeImmediateLeftRecursion")
            return "Remove immediate left recursion from " + Helpers.formatSymbol(productions[transformation.production][transformation.symbol], info);
          else if (transformation.name == "leftFactor")
            return "Left-factor " + Helpers.formatSymbols(productions[transformation.production].slice(1, transformation.prefix), info).join(" ") + " out of " + Helpers.formatSymbol(productions[transformation.production][transformation.symbol], info);
          
        }
  
        function update(params) {
    
          var table = $("<table></table>");
    
          params.productions.forEach(function(production, index) {
      
            var head = production[0];
            var body = production.slice(1);
      
            var row = $("<tr></tr>");
            
            row.append("<td>" + index + "</td>");
            row.append("<td>" + Helpers.formatProduction(production, params.info) + "</td>");
            
            var cell = $("<td></td>");
            
            params.transformations.forEach(function(transformation) {
              
              var button;
              
              if (transformation.production === index) {
                button = $("<button>" + formatTransformation(transformation, params.productions, params.info) + "</button>").on("click", function() { performTransformation(transformation); } );
                cell.append(button);
              }
              
            });
            
            row.append(cell);
      
            table.append(row);
      
          });
    
          $(this.element).html(table);
    
        }
  
        var klass = initialize;
        klass.prototype.update = update;
  
        return klass;
        
      })();
      
      function performTransformation(transformation) {
        
        grammar = grammar.transform(transformation.name, transformation);
        
        transformView.update({
          productions: grammar.calculate("grammar.productions"),
          info: grammar.calculate("grammar.symbolInfo"),
          transformations: grammar.calculate("transformations")
        });
        
      }
      
      var grammar = new Grammar([
        ["A", "x"],
        ["A", "x", "y"],
        ["A", "B"],
        ["B"]
      ]);
      
      var transformView = new TransformView();
      
      transformView.update({
        productions: grammar.calculate("grammar.productions"),
        info: grammar.calculate("grammar.symbolInfo"),
        transformations: grammar.calculate("transformations")
      });
      
      $("#results").append(transformView.element);
      
      $("#edit").on("click", function() {
        $(document.body).removeClass("transform");
        $(document.body).addClass("edit");
        
        document.getElementById("spec").value = grammar.toString();
      });
      
      $("#transform").on("click", function() {
        $(document.body).removeClass("edit");
        $(document.body).addClass("transform");
        
        var result;
        
        spec = document.getElementById("spec").value;
        result = Grammar.parse(spec);
        
        grammar = result.grammar;
        
        transformView.update({
          productions: grammar.calculate("grammar.productions"),
          info: grammar.calculate("grammar.symbolInfo"),
          transformations: grammar.calculate("transformations")
        });
      });
      
    </script>
    
  </body>
</html>