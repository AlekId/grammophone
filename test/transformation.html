<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Transformation</title>
    <link rel="stylesheet" href="../views.css">
    <style>
      
      article {
        margin: 1em 0;
      }
      
      button {
        display: block;
      }
      
    </style>
  </head>
  <body>
    
    <section id="results">
    </section>
    
    <script src="../lib/zepto.js"></script>
    <script src="grammars.js"></script>
    <script src="functional.js"></script>
    <script src="../src/relation.js"></script>
    <script src="../src/set.js"></script>
    <script src="../src/parser.js"></script>
    <script src="../src/grammar.js"></script>
    <script src="../src/calculations.js"></script>
    <script src="../src/calculations/grammar.js"></script>
    <script src="../src/calculations/transformations.js"></script>
    <script src="../src/transformations.js"></script>
    <script src="../src/helpers.js"></script>
    <script src="../src/views.js"></script>
    <script src="../src/views/productions.js"></script>
    <script>
    
      var TransformView = (function() {
  
        function initialize() {
          this.element = $("<article></article>");
        }
        
        function formatTransformation(transformation, productions, info) {
          
          if (transformation.name == "expand")
            return "Expand " + Helpers.formatSymbol(productions[transformation.production][transformation.symbol], info);
          else if (transformation.name == "removeImmediateLeftRecursion")
            return "Remove immediate left recursion from " + Helpers.formatSymbol(productions[transformation.production][transformation.symbol], info);
          
        }
  
        function update(params) {
    
          var table = $("<table></table>");
    
          params.productions.forEach(function(production, index) {
      
            var head = production[0];
            var body = production.slice(1);
      
            var row = $("<tr></tr>");
            
            row.append("<td>" + index + "</td>");
            row.append("<td>" + Helpers.formatSymbol(head, params.info) + "</td>");
            row.append("<td>&rarr;</td>");
            row.append("<td>" + Helpers.formatSymbols(body, params.info).join(" ") + "</td>");
            
            var cell = $("<td></td>");
            
            params.transformations.forEach(function(transformation) {
              
              var button;
              
              if (transformation.production === index) {
                button = $("<button>" + formatTransformation(transformation, params.productions, params.info) + "</button>").on("click", function() { performTransformation(transformation); } );
                cell.append(button);
              }
              
            });
            
            row.append(cell);
      
            table.append(row);
      
          });
    
          $(this.element).html(table);
    
        }
  
        var klass = initialize;
        klass.prototype.update = update;
  
        return klass;
        
      })();
      
      function performTransformation(transformation) {
        
        grammar = grammar.transform(transformation.name, transformation);
        
        transformView.update({
          productions: grammar.calculate("grammar.productions"),
          info: grammar.calculate("grammar.symbolInfo"),
          transformations: grammar.calculate("transformations")
        });
        
      }
      
      var grammar = new Grammar([
        ["B", "A", "a"],
        ["A", "A", "B", "a"],
        ["B", "x"],
        ["A", "B"]
      ]);
      
      var transformView = new TransformView();
      
      transformView.update({
        productions: grammar.calculate("grammar.productions"),
        info: grammar.calculate("grammar.symbolInfo"),
        transformations: grammar.calculate("transformations")
      });
      
      $("#results").append(transformView.element);
      
    </script>
    
  </body>
</html>