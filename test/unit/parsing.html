<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Parsing</title>
    <style>
    
      article {
        margin: 1em 0;
      }
    
      article.fail {
        background: #fcc;
      }
      
      article.fail b {
        background: #ebb;
      }
    
      article.pass {
        background: #cfc;
      }
      
      article.pass b {
        background: #beb;
      }
      
    </style>
  </head>
  <body>
    
    <script src="./test.js"></script>
    <script src="/assets/application.js"></script>
    <script>
      
      function productionsEqual(a, b) {
        
        var i, j;
        
        if (a.length !== b.length)
          return false;
        
        for (i = 0; i < a.length; i++) {
          if (a[i].length !== b[i].length)
            return false;
          
          for (j = 0; j < a[i].length; j++) {
            if (a[i][j] !== b[i][j])
              return false;
          }
        }
        
        return true;
        
      }
      
      function inspectProductionsAsList(productions) {
        
        return "<ul class=\"p\">" + productions.map(function(p) {
          
          return "<li>" +
            "<b>" + Helpers.escapeHTML(p[0]) + "</b> &rarr; " +
            p.slice(1).map(function(s) { return "<b>" + Helpers.escapeHTML(s) + "</b>"; }).join(" ") +
            "</li>";
          
        }).join("") + "</ul>";
        
      }
      
      function assertProductions(spec, expected) {
        
        var result = Grammar.parse(spec);
        
        if (result.error)
          fail("<p>Unexpected parse error:</p><pre>" + result.error.toString() + "</pre><p>Spec:</p><pre>" + spec + "</pre>");
        else if (!productionsEqual(expected, result.grammar.productions))
          fail("<p>Expected:</p>" + inspectProductionsAsList(expected) + "<p>Actual:</p>" + inspectProductionsAsList(result.grammar.productions) + "<p>Spec:</p><pre>" + spec + "</pre>");
        else
          pass("<pre>" + spec + "</pre>" + inspectProductionsAsList(expected));
        
      }
      
      function assertParseError(spec) {
        
        var result = Grammar.parse(spec);
        
        if (result.error)
          pass("<pre>" + spec + "</pre><pre>" + result.error.toString() + "</pre>");
        else
          fail("<p>Expected parse error for spec, none thrown:</p><pre>" + spec + "</pre>");
        
      }
      
      test("Parsing", function() {
        
        assertProductions("A -> a | b.", [["A", "a"], ["A", "b"]]);
        assertProductions("A->a|b.", [["A", "a"], ["A", "b"]]);
        assertProductions("A -> .", [["A"]]);
        assertProductions("A->.", [["A"]]);
        assertProductions("A -> a. B -> b.", [["A", "a"], ["B", "b"]]);
        assertProductions("A->a.", [["A", "a"]]);
        assertProductions("1 -> 5 6.", [["1", "5", "6"]]);
        assertProductions("** -> 42.", [["**", "42"]]);
        assertProductions("A -> x - y.", [["A", "x", "-", "y"]]);
        assertProductions("-->-. - -> -.", [["-", "-"], ["-", "-"]]);
        assertProductions("A -> x > y.", [["A", "x", ">", "y"]]);
        assertProductions("\"x.y\" -> \" \" \"->\".", [["x.y", " ", "->"]]);
        assertProductions("'x.y' -> ' ' '->'.", [["x.y", " ", "->"]]);
        assertProductions("a -> \"'\" \"\\\"\" '\\'' '\"'.", [["a", "'", "\"", "'", "\""]]);
        assertProductions("A -> \\\".", [["A", "\""]]);
        assertProductions("A -> \\..", [["A", "."]]);
        assertProductions("A -> a\\.a.", [["A", "a.a"]]);
        assertProductions("a -> a-b.", [["a", "a-b"]]);
        assertProductions("a-b -> a-b.", [["a-b", "a-b"]]);
        assertProductions("a-b->a-b.", [["a-b", "a-b"]]);
        assertProductions("a'->x.", [["a'", "x"]]);
        assertProductions("a''->x'''.y'->b''.", [["a''", "x'''"], ["y'", "b''"]]);
        
        assertParseError("A -> a. B");
        assertParseError("A.y -> a.");
        assertParseError("A B -> a.");
        assertParseError("A -> a. ->");
        assertParseError("-> X");
        assertParseError("A");
        assertParseError("A -> \"x");
        assertParseError("A -> \"x\\\"");
        assertParseError("a->x.y .");
        assertParseError("a -> '.");
        assertParseError("a -> \".");
        assertParseError("a -> b\"c\".");
        assertParseError("a -> b'c.");
        assertParseError("a -> b'''c.");
        assertParseError("a -> b'c '.");
        assertParseError("a -> \"\".");
        assertParseError("a -> ''.");
        
      });
      
    </script>
    
  </body>
</html>
